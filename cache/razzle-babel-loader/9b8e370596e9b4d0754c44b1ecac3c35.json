{"ast":null,"code":"import _extends from \"/home/jakob/workspace/training-project/node_modules/@babel/runtime/helpers/esm/extends\";\n\nvar _jsxFileName = \"/home/jakob/workspace/training-project/node_modules/@plone/volto/packages/volto-slate/src/widgets/HtmlSlateWidget.jsx\",\n    _s = $RefreshSig$();\n\nvar __jsx = React.createElement;\n\n/**\n * HtmlSlateWidget, a slate widget variant that saves its data as HTML\n */\nimport React from 'react';\nimport ReactDOMServer from 'react-dom/server';\nimport configureStore from 'redux-mock-store';\nimport { MemoryRouter } from 'react-router-dom';\nimport { Provider, useSelector } from 'react-redux';\nimport { defineMessages, injectIntl } from 'react-intl';\nimport { FormFieldWrapper } from '@plone/volto/components';\nimport SlateEditor from '@plone/volto-slate/editor/SlateEditor';\nimport { serializeNodes } from '@plone/volto-slate/editor/render';\nimport { makeEditor } from '@plone/volto-slate/utils';\nimport deserialize from '@plone/volto-slate/editor/deserialize';\nimport { createEmptyParagraph, normalizeExternalData } from '@plone/volto-slate/utils';\nimport { ErrorBoundary } from './ErrorBoundary';\nimport './style.css';\nconst messages = defineMessages({\n  error: {\n    \"id\": \"An error has occurred while editing \\\"{name}\\\" field. We have been notified and we are looking into it. Please save your work and retry. If the issue persists please contact the site administrator.\",\n    \"defaultMessage\": \"An error has occurred while editing \\\"{name}\\\" field. We have been notified and we are looking into it. Please save your work and retry. If the issue persists please contact the site administrator.\"\n  }\n});\n\nconst HtmlSlateWidget = props => {\n  _s();\n\n  const {\n    id,\n    onChange,\n    value,\n    focus,\n    className,\n    block,\n    placeholder,\n    properties,\n    intl\n  } = props;\n  const [selected, setSelected] = React.useState(focus);\n  const editor = React.useMemo(() => makeEditor(), []);\n  const token = useSelector(state => state.userSession.token);\n  const toHtml = React.useCallback(value => {\n    const mockStore = configureStore();\n    const html = ReactDOMServer.renderToStaticMarkup(__jsx(Provider, {\n      store: mockStore({\n        userSession: {\n          token\n        }\n      }),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 58,\n        columnNumber: 9\n      }\n    }, __jsx(MemoryRouter, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 59,\n        columnNumber: 11\n      }\n    }, serializeNodes(value || [])))); // console.log('toHtml value', JSON.stringify(value));\n    // console.log('toHtml html', html);\n\n    return {\n      'content-type': value ? value['content-type'] : 'text/html',\n      encoding: value ? value.encoding : 'utf8',\n      data: html\n    };\n  }, [token]);\n  const fromHtml = React.useCallback(value => {\n    const html = (value === null || value === void 0 ? void 0 : value.data) || '';\n    const parsed = new DOMParser().parseFromString(html, 'text/html');\n    const body = parsed.getElementsByTagName('google-sheets-html-origin').length > 0 ? parsed.querySelector('google-sheets-html-origin > table') : parsed.body;\n    let data = deserialize(editor, body);\n    data = normalizeExternalData(editor, data); // editor.children = data;\n    // Editor.normalize(editor);\n    // TODO: need to add {text: \"\"} placeholders between elements\n\n    const res = data.length ? data : [createEmptyParagraph()]; // console.log('from html', { html: value?.data, res });\n\n    return res;\n  }, [editor]);\n  const valueFromHtml = React.useMemo(() => {\n    return fromHtml(value);\n  }, [value, fromHtml]);\n  const handleChange = React.useCallback(newValue => {\n    onChange(id, toHtml(newValue));\n  }, [onChange, toHtml, id]);\n  const handleClick = React.useCallback(() => {\n    setSelected(true);\n  }, []);\n  return __jsx(FormFieldWrapper, _extends({}, props, {\n    draggable: false,\n    className: \"slate_wysiwyg\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 112,\n      columnNumber: 5\n    }\n  }), __jsx(\"div\", {\n    className: \"slate_wysiwyg_box\",\n    role: \"textbox\",\n    tabIndex: \"-1\",\n    style: {\n      boxSizing: 'initial'\n    },\n    onClick: handleClick,\n    onKeyDown: () => {},\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 113,\n      columnNumber: 7\n    }\n  }, __jsx(ErrorBoundary, {\n    name: intl.formatMessage(messages.error, {\n      name: id\n    }),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 121,\n      columnNumber: 9\n    }\n  }, __jsx(SlateEditor, {\n    className: className,\n    id: id,\n    name: id,\n    value: valueFromHtml,\n    onChange: handleChange,\n    block: block,\n    selected: selected,\n    properties: properties,\n    placeholder: placeholder,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 122,\n      columnNumber: 11\n    }\n  }))));\n};\n\n_s(HtmlSlateWidget, \"5QVgoyGmX8qPxdfyLQhITSgJC04=\", false, function () {\n  return [useSelector];\n});\n\n_c = HtmlSlateWidget;\nexport default _c2 = injectIntl(HtmlSlateWidget);\n\nvar _c, _c2;\n\n$RefreshReg$(_c, \"HtmlSlateWidget\");\n$RefreshReg$(_c2, \"%default%\");","map":{"version":3,"names":["React","ReactDOMServer","configureStore","MemoryRouter","Provider","useSelector","defineMessages","injectIntl","FormFieldWrapper","SlateEditor","serializeNodes","makeEditor","deserialize","createEmptyParagraph","normalizeExternalData","ErrorBoundary","messages","error","HtmlSlateWidget","props","id","onChange","value","focus","className","block","placeholder","properties","intl","selected","setSelected","useState","editor","useMemo","token","state","userSession","toHtml","useCallback","mockStore","html","renderToStaticMarkup","encoding","data","fromHtml","parsed","DOMParser","parseFromString","body","getElementsByTagName","length","querySelector","res","valueFromHtml","handleChange","newValue","handleClick","boxSizing","formatMessage","name"],"sources":["/home/jakob/workspace/training-project/node_modules/@plone/volto/packages/volto-slate/src/widgets/HtmlSlateWidget.jsx"],"sourcesContent":["/**\n * HtmlSlateWidget, a slate widget variant that saves its data as HTML\n */\n\nimport React from 'react';\nimport ReactDOMServer from 'react-dom/server';\nimport configureStore from 'redux-mock-store';\nimport { MemoryRouter } from 'react-router-dom';\nimport { Provider, useSelector } from 'react-redux';\nimport { defineMessages, injectIntl } from 'react-intl';\n\nimport { FormFieldWrapper } from '@plone/volto/components';\nimport SlateEditor from '@plone/volto-slate/editor/SlateEditor';\nimport { serializeNodes } from '@plone/volto-slate/editor/render';\nimport { makeEditor } from '@plone/volto-slate/utils';\nimport deserialize from '@plone/volto-slate/editor/deserialize';\n\nimport {\n  createEmptyParagraph,\n  normalizeExternalData,\n} from '@plone/volto-slate/utils';\nimport { ErrorBoundary } from './ErrorBoundary';\n\nimport './style.css';\n\nconst messages = defineMessages({\n  error: {\n    id:\n      'An error has occurred while editing \"{name}\" field. We have been notified and we are looking into it. Please save your work and retry. If the issue persists please contact the site administrator.',\n    defaultMessage:\n      'An error has occurred while editing \"{name}\" field. We have been notified and we are looking into it. Please save your work and retry. If the issue persists please contact the site administrator.',\n  },\n});\n\nconst HtmlSlateWidget = (props) => {\n  const {\n    id,\n    onChange,\n    value,\n    focus,\n    className,\n    block,\n    placeholder,\n    properties,\n    intl,\n  } = props;\n\n  const [selected, setSelected] = React.useState(focus);\n\n  const editor = React.useMemo(() => makeEditor(), []);\n\n  const token = useSelector((state) => state.userSession.token);\n\n  const toHtml = React.useCallback(\n    (value) => {\n      const mockStore = configureStore();\n      const html = ReactDOMServer.renderToStaticMarkup(\n        <Provider store={mockStore({ userSession: { token } })}>\n          <MemoryRouter>{serializeNodes(value || [])}</MemoryRouter>\n        </Provider>,\n      );\n      // console.log('toHtml value', JSON.stringify(value));\n      // console.log('toHtml html', html);\n\n      return {\n        'content-type': value ? value['content-type'] : 'text/html',\n        encoding: value ? value.encoding : 'utf8',\n        data: html,\n      };\n    },\n    [token],\n  );\n\n  const fromHtml = React.useCallback(\n    (value) => {\n      const html = value?.data || '';\n\n      const parsed = new DOMParser().parseFromString(html, 'text/html');\n      const body =\n        parsed.getElementsByTagName('google-sheets-html-origin').length > 0\n          ? parsed.querySelector('google-sheets-html-origin > table')\n          : parsed.body;\n      let data = deserialize(editor, body);\n      data = normalizeExternalData(editor, data);\n\n      // editor.children = data;\n      // Editor.normalize(editor);\n      // TODO: need to add {text: \"\"} placeholders between elements\n      const res = data.length ? data : [createEmptyParagraph()];\n      // console.log('from html', { html: value?.data, res });\n      return res;\n    },\n    [editor],\n  );\n\n  const valueFromHtml = React.useMemo(() => {\n    return fromHtml(value);\n  }, [value, fromHtml]);\n\n  const handleChange = React.useCallback(\n    (newValue) => {\n      onChange(id, toHtml(newValue));\n    },\n    [onChange, toHtml, id],\n  );\n\n  const handleClick = React.useCallback(() => {\n    setSelected(true);\n  }, []);\n\n  return (\n    <FormFieldWrapper {...props} draggable={false} className=\"slate_wysiwyg\">\n      <div\n        className=\"slate_wysiwyg_box\"\n        role=\"textbox\"\n        tabIndex=\"-1\"\n        style={{ boxSizing: 'initial' }}\n        onClick={handleClick}\n        onKeyDown={() => {}}\n      >\n        <ErrorBoundary name={intl.formatMessage(messages.error, { name: id })}>\n          <SlateEditor\n            className={className}\n            id={id}\n            name={id}\n            value={valueFromHtml}\n            onChange={handleChange}\n            block={block}\n            selected={selected}\n            properties={properties}\n            placeholder={placeholder}\n          />\n        </ErrorBoundary>\n      </div>\n    </FormFieldWrapper>\n  );\n};\n\nexport default injectIntl(HtmlSlateWidget);\n"],"mappings":"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"},"metadata":{"react-intl":{"messages":[{"id":"An error has occurred while editing \"{name}\" field. We have been notified and we are looking into it. Please save your work and retry. If the issue persists please contact the site administrator.","defaultMessage":"An error has occurred while editing \"{name}\" field. We have been notified and we are looking into it. Please save your work and retry. If the issue persists please contact the site administrator."}]}},"sourceType":"module"}